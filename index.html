<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TweetFeed</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
    </style>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main App Container -->
    <div id="app-container" class="bg-white rounded-3xl shadow-xl w-full max-w-md h-[90vh] flex flex-col overflow-hidden">
        
        <!-- Header -->
        <header class="bg-white p-4 border-b border-gray-200 flex items-center justify-between z-10">
            <h1 class="text-2xl font-bold text-gray-800">TweetFeed</h1>
            <div id="auth-status-container" class="flex items-center space-x-2">
                <!-- Auth status and profile image will be rendered here -->
            </div>
        </header>

        <!-- Main Content Area -->
        <main id="main-content" class="flex-1 overflow-y-auto p-4 bg-gray-50 pb-20">
            <!-- Content will be dynamically loaded here based on navigation -->
            <div id="loading-spinner" class="flex justify-center items-center h-full">
                <i class="fa-solid fa-spinner fa-spin-pulse text-4xl text-blue-500"></i>
            </div>
        </main>

        <!-- Bottom Navigation Bar -->
        <nav id="bottom-nav" class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-md bg-white border-t border-gray-200 grid grid-cols-3 z-20 hidden">
            <button id="nav-feed" class="flex flex-col items-center justify-center py-2 px-4 text-blue-500 hover:bg-gray-100 transition-colors">
                <i class="fa-solid fa-home text-2xl"></i>
                <span class="text-xs mt-1">Feed</span>
            </button>
            <button id="nav-profiles" class="flex flex-col items-center justify-center py-2 px-4 text-gray-500 hover:bg-gray-100 transition-colors">
                <i class="fa-solid fa-user-group text-2xl"></i>
                <span class="text-xs mt-1">Profiles</span>
            </button>
            <button id="nav-messages" class="flex flex-col items-center justify-center py-2 px-4 text-gray-500 hover:bg-gray-100 transition-colors">
                <i class="fa-solid fa-comment-dots text-2xl"></i>
                <span class="text-xs mt-1">Messages</span>
            </button>
        </nav>

        <!-- Custom Modal for Alerts/Confirmations -->
        <div id="custom-modal" class="modal">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm text-center">
                <h3 id="modal-title" class="text-xl font-semibold mb-2 text-gray-800"></h3>
                <p id="modal-message" class="text-gray-600 mb-4"></p>
                <div class="flex justify-center space-x-4">
                    <button id="modal-ok-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">OK</button>
                    <button id="modal-cancel-btn" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors hidden">Cancel</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs & App Logic -->
    <script type="module">
        // Global variables provided by the Canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAWi42vGIbO7e5GC3AVwoYPhr57k-I-sLk",
            authDomain: "tweetfeed-226dd.firebaseapp.com",
            projectId: "tweetfeed-226dd",
            storageBucket: "tweetfeed-226dd.firebasestorage.app",
            messagingSenderId: "488247621544",
            appId: "1:488247621544:web:ecb8ea89cad9adf5df8f9d",
            measurementId: "G-2ZMGDMJH7M"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Firebase Imports from v11.6.1 CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signInWithCustomToken, 
            onAuthStateChanged, 
            signOut,
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            collection, 
            query, 
            where, 
            onSnapshot, 
            serverTimestamp,
            getDocs,
            updateDoc,
            deleteDoc,
            runTransaction
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        let db;
        let auth;
        let userId = null;
        let userProfile;
        
        // UI elements
        const mainContent = document.getElementById('main-content');
        const bottomNav = document.getElementById('bottom-nav');
        const navButtons = bottomNav.querySelectorAll('button');
        const authContainer = document.getElementById('auth-status-container');
        const loadingSpinner = document.getElementById('loading-spinner');

        // Modal elements
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalOkBtn = document.getElementById('modal-ok-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

        // Show a custom modal instead of alert()
        function showModal(title, message, isConfirmation = false) {
            return new Promise((resolve) => {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalCancelBtn.style.display = isConfirmation ? 'inline-block' : 'none';
                modal.style.display = 'flex';

                modalOkBtn.onclick = () => {
                    modal.style.display = 'none';
                    resolve(true);
                };
                modalCancelBtn.onclick = () => {
                    modal.style.display = 'none';
                    resolve(false);
                };
            });
        }

        // --- Firebase Initialization and Authentication ---

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Sign in with the provided custom token
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                }

                // Listen for auth state changes to render UI
                onAuthStateChanged(auth, async (user) => {
                    loadingSpinner.style.display = 'none';
                    if (user) {
                        userId = user.uid;
                        await checkAndSetUserProfile(user);
                        renderAuthStatus(user);
                    } else {
                        userId = null;
                        userProfile = null;
                        renderAuthStatus(null);
                        renderLoginScreen();
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                loadingSpinner.style.display = 'none';
                await showModal("Initialization Error", "Failed to connect to the backend. Please check the console for details.");
            }
        }
        
        // Checks for profile and handles routing
        async function checkAndSetUserProfile(user) {
            const userDocRef = doc(db, 'artifacts', appId, 'users', userId, 'profile', 'data');
            const userDocSnap = await getDoc(userDocRef);

            if (!userDocSnap.exists()) {
                if (window.location.pathname !== '/createprofile') {
                    window.history.pushState({}, '', '/createprofile');
                    handleUrlChange();
                }
            } else {
                userProfile = userDocSnap.data();
                if (userProfile.isBanned) {
                    await signOut(auth);
                    await showModal("Account Banned", "Your account has been banned. You cannot sign in.");
                    return;
                }
                if (window.location.pathname === '/createprofile') {
                     window.history.pushState({}, '', '/');
                     handleUrlChange();
                } else {
                    handleUrlChange();
                }
            }
        }

        // Renders the auth status container (sign-in/sign-out buttons)
        function renderAuthStatus(user) {
            authContainer.innerHTML = '';
            if (user) {
                const userDiv = document.createElement('div');
                userDiv.className = "flex items-center space-x-2";
                userDiv.innerHTML = `
                    <span class="text-sm font-medium text-gray-600 hidden sm:inline">${user.displayName || 'You'}</span>
                    <img src="${user.photoURL || 'https://placehold.co/40x40/A0AEC0/ffffff?text=U'}" alt="Profile" class="w-10 h-10 rounded-full cursor-pointer hover:ring-2 ring-blue-500 transition-all">
                    <button id="sign-out-btn" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-lg hover:bg-gray-300 transition-colors">
                        <i class="fa-solid fa-right-from-bracket"></i>
                        <span class="ml-1 hidden sm:inline">Sign Out</span>
                    </button>
                `;
                authContainer.appendChild(userDiv);
                userDiv.querySelector('img').addEventListener('click', () => showView('profiles'));
                document.getElementById('sign-out-btn').addEventListener('click', () => {
                    signOut(auth);
                });
            }
        }
        
        function renderLoginScreen() {
             mainContent.innerHTML = `
                <div class="flex flex-col items-center justify-center p-8 text-center h-full">
                    <img src="https://placehold.co/150x150/d1d5db/374151?text=Login" alt="Login Illustration" class="mb-6 rounded-full">
                    <h2 class="text-2xl font-bold mb-2">Welcome to TweetFeed</h2>
                    <p class="text-gray-600 mb-6">Sign in to view the feed, manage your profile, and send messages.</p>
                    <button id="sign-in-btn" class="bg-blue-500 text-white px-6 py-3 rounded-full font-semibold shadow-md hover:bg-blue-600 transition-colors text-lg">
                        <i class="fa-brands fa-google mr-2"></i>Sign In with Google
                    </button>
                </div>
            `;
            document.getElementById('sign-in-btn').addEventListener('click', async () => {
                try {
                    const provider = new GoogleAuthProvider();
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error("Error during Google sign-in:", error);
                    await showModal("Sign-in Failed", "Could not sign in with Google. Please try again.");
                }
            });
            bottomNav.classList.add('hidden');
        }

        // --- View Rendering and Routing Functions ---

        // Simple client-side router
        window.handleUrlChange = () => {
            const path = window.location.pathname;
            if (!userId) {
                if (path !== '/createprofile') {
                    renderLoginScreen();
                }
                return;
            }
            
            bottomNav.classList.remove('hidden');
            navButtons.forEach(btn => btn.classList.replace('text-blue-500', 'text-gray-500'));
            
            if (path === '/createprofile') {
                renderCreateProfilePage();
            } else if (path === '/editprofile') {
                renderEditProfilePage();
            } else if (path.startsWith('/profiles/@')) {
                renderUserProfilePage(path.split('/@')[1]);
            } else if (path.startsWith('/profiles')) {
                document.getElementById('nav-profiles').classList.replace('text-gray-500', 'text-blue-500');
                renderProfiles();
            } else if (path.startsWith('/messages')) {
                document.getElementById('nav-messages').classList.replace('text-gray-500', 'text-blue-500');
                renderMessages();
            } else if (path.startsWith('/message/')) {
                 document.getElementById('nav-messages').classList.replace('text-gray-500', 'text-blue-500');
                 renderMessageSession(path.split('/')[2]);
            } else if (path.startsWith('/share/')) {
                 renderSharePage(path.split('/')[2]);
            } else {
                document.getElementById('nav-feed').classList.replace('text-gray-500', 'text-blue-500');
                renderFeed();
            }
        };

        window.showView = (viewName, data = null) => {
            let newPath = '/';
            if (viewName === 'createprofile') newPath = '/createprofile';
            else if (viewName === 'editprofile') newPath = '/editprofile';
            else if (viewName === 'profiles') newPath = '/profiles';
            else if (viewName === 'user_profile' && data) newPath = `/profiles/@${data}`;
            else if (viewName === 'messages') newPath = '/messages';
            else if (viewName === 'message_session' && data) newPath = `/message/${data}`;
            else if (viewName === 'share' && data) newPath = `/share/${data}`;
            
            window.history.pushState({}, '', newPath);
            handleUrlChange();
        };

        // --- New View for Profile Creation ---
        function renderCreateProfilePage() {
            mainContent.innerHTML = `
                <div class="p-6 bg-white rounded-xl shadow-xl">
                    <h2 class="text-2xl font-bold mb-4 text-center">Create Your Profile</h2>
                    <p class="text-gray-600 mb-6 text-center">Your username will be permanent and unique.</p>
                    <form id="create-profile-form" class="space-y-4">
                        <div>
                            <label for="display-name" class="block text-sm font-medium text-gray-700">Display Name (Optional)</label>
                            <input type="text" id="display-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-700">Username (Permanent)</label>
                            <input type="text" id="username" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-blue-500 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label for="bio" class="block text-sm font-medium text-gray-700">Bio</label>
                            <textarea id="bio" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-blue-500 focus:ring-blue-500"></textarea>
                        </div>
                        <button type="submit" class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-600 transition-colors">Create Profile</button>
                    </form>
                </div>
            `;
            document.getElementById('create-profile-form').addEventListener('submit', createProfile);
            bottomNav.classList.add('hidden');
            authContainer.innerHTML = '';
        }

        async function createProfile(e) {
            e.preventDefault();
            const displayName = document.getElementById('display-name').value;
            const username = document.getElementById('username').value.toLowerCase().trim();
            const bio = document.getElementById('bio').value;

            if (!username) {
                await showModal("Error", "Username is required.");
                return;
            }

            try {
                // Use a Firestore transaction to ensure both writes succeed or fail together
                await runTransaction(db, async (transaction) => {
                    const usernamesRef = doc(db, 'artifacts', appId, 'public', 'data', 'usernames', username);
                    const usernameSnap = await transaction.get(usernamesRef);

                    if (usernameSnap.exists()) {
                        throw new Error("Username already taken. Please choose another.");
                    }
                    
                    const userDocRef = doc(db, 'artifacts', appId, 'users', userId, 'profile', 'data');
                    const newProfile = {
                        displayName: displayName || auth.currentUser.displayName,
                        username: username,
                        bio: bio,
                        photoURL: auth.currentUser.photoURL,
                        email: auth.currentUser.email,
                        createdAt: serverTimestamp(),
                        isBanned: false
                    };

                    transaction.set(userDocRef, newProfile);
                    transaction.set(usernamesRef, { userId: userId, displayName: newProfile.displayName });
                    
                    userProfile = newProfile;
                });
                
                window.history.pushState({}, '', '/');
                handleUrlChange();
            } catch (error) {
                console.error("Error creating profile:", error);
                await showModal("Error", error.message || "Failed to create profile. Please try again.");
            }
        }

        // --- New View for Profile Editing ---
        function renderEditProfilePage() {
            if (!userProfile) return;
            mainContent.innerHTML = `
                <div class="p-6 bg-white rounded-xl shadow-xl">
                    <h2 class="text-2xl font-bold mb-4 text-center">Edit Your Profile</h2>
                    <form id="edit-profile-form" class="space-y-4">
                        <div>
                            <label for="display-name" class="block text-sm font-medium text-gray-700">Display Name</label>
                            <input type="text" id="display-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-blue-500 focus:ring-blue-500" value="${userProfile.displayName}">
                        </div>
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-700">Username (Permanent)</label>
                            <input type="text" id="username" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-100 cursor-not-allowed" value="${userProfile.username}" readonly>
                        </div>
                        <div>
                            <label for="bio" class="block text-sm font-medium text-gray-700">Bio</label>
                            <textarea id="bio" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-blue-500 focus:ring-blue-500">${userProfile.bio}</textarea>
                        </div>
                        <button type="submit" class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-600 transition-colors">Save Changes</button>
                    </form>
                </div>
            `;
            document.getElementById('edit-profile-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newDisplayName = document.getElementById('display-name').value;
                const newBio = document.getElementById('bio').value;

                const userDocRef = doc(db, 'artifacts', appId, 'users', userId, 'profile', 'data');
                await updateDoc(userDocRef, { displayName: newDisplayName, bio: newBio });
                await showModal("Success", "Profile updated successfully!");
                showView('profiles');
            });
        }

        // Render the main feed
        function renderFeed() {
            mainContent.innerHTML = `
                <!-- New Post Form -->
                <div class="bg-white p-4 rounded-xl shadow-md mb-4">
                    <div class="flex items-start space-x-3 mb-2">
                        <img src="${userProfile?.photoURL || 'https://placehold.co/40x40/A0AEC0/ffffff?text=U'}" alt="Profile" class="w-10 h-10 rounded-full">
                        <textarea id="new-post-content" class="w-full h-24 p-2 text-gray-700 bg-gray-50 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="What's happening?"></textarea>
                    </div>
                    <button id="post-btn" class="w-full bg-blue-500 text-white py-2 rounded-lg font-semibold hover:bg-blue-600 transition-colors">Post</button>
                </div>

                <!-- Feed Posts -->
                <div id="posts-container">
                    <p class="text-center text-gray-500 mt-8">Loading posts...</p>
                </div>
            `;

            document.getElementById('post-btn').addEventListener('click', postTweet);

            // Fetch and display posts in real-time
            const postsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
            const postsContainer = document.getElementById('posts-container');
            const q = query(postsColRef);
            
            onSnapshot(q, async (snapshot) => {
                postsContainer.innerHTML = '';
                if (snapshot.empty) {
                    postsContainer.innerHTML = `<p class="text-center text-gray-500 mt-8">No posts yet. Be the first to post!</p>`;
                    return;
                }

                const postDocs = snapshot.docs;
                const authorIds = new Set(postDocs.map(doc => doc.data().userId));
                
                const profilePromises = Array.from(authorIds).map(authorId => 
                    getDoc(doc(db, 'artifacts', appId, 'users', authorId, 'profile', 'data'))
                );
                const profileSnaps = await Promise.all(profilePromises);

                const profiles = {};
                profileSnaps.forEach(snap => {
                    if (snap.exists()) {
                        const profileData = snap.data();
                        profiles[snap.ref.parent.parent.id] = profileData; // Key by user ID
                    }
                });

                const sortedDocs = postDocs.sort((a, b) => b.data().createdAt?.toMillis() - a.data().createdAt?.toMillis());
                
                sortedDocs.forEach(doc => {
                    const post = doc.data();
                    const postId = doc.id;
                    const authorProfile = profiles[post.userId] || { isBanned: false };

                    if (authorProfile.isBanned) return;

                    const postElement = document.createElement('div');
                    postElement.className = "bg-white p-4 rounded-xl shadow-md mb-4";
                    
                    const timeString = post.createdAt ? new Date(post.createdAt.toMillis()).toLocaleString() : 'Just now';
                    
                    // New Commenting and Likes UI
                    postElement.innerHTML = `
                        <div class="flex items-start justify-between">
                            <div class="flex items-center space-x-3 mb-2 cursor-pointer">
                                <img src="${post.photoURL || 'https://placehold.co/40x40/A0AEC0/ffffff?text=U'}" alt="Profile" class="w-10 h-10 rounded-full">
                                <div>
                                    <p class="font-semibold text-gray-800">${post.displayName || post.name}</p>
                                    <p class="text-xs text-gray-500">@${post.username || 'unknown'}</p>
                                    <p class="text-xs text-gray-500">${timeString}</p>
                                </div>
                            </div>
                            ${post.userId === userId ? `
                                <button class="delete-post-btn text-gray-400 hover:text-red-500 transition-colors">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                        <p class="text-gray-700 leading-relaxed mb-4">${post.content}</p>
                        <div class="flex items-center justify-around text-gray-500 text-sm">
                            <button class="like-btn flex items-center space-x-1 hover:text-red-500 transition-colors" data-id="${postId}">
                                <i class="fa-regular fa-heart"></i>
                                <span class="like-count">0</span>
                            </button>
                            <button class="dislike-btn flex items-center space-x-1 hover:text-blue-500 transition-colors" data-id="${postId}">
                                <i class="fa-regular fa-thumbs-down"></i>
                                <span class="dislike-count">0</span>
                            </button>
                            <button class="comment-btn flex items-center space-x-1 hover:text-gray-700 transition-colors" data-id="${postId}">
                                <i class="fa-solid fa-comment"></i>
                                <span class="comment-count">0</span>
                            </button>
                            <button class="share-btn flex items-center space-x-1 hover:text-green-500 transition-colors" data-id="${postId}">
                                <i class="fa-solid fa-share"></i>
                                <span>Share</span>
                            </button>
                        </div>
                        <div id="comments-section-${postId}" class="mt-4 hidden">
                            <div class="flex items-start space-x-2 mt-4">
                                <img src="${userProfile?.photoURL || 'https://placehold.co/40x40/A0AEC0/ffffff?text=U'}" alt="Profile" class="w-8 h-8 rounded-full">
                                <div class="flex-1 relative">
                                    <input type="text" placeholder="Add a comment..." class="w-full p-2 text-sm rounded-lg border-2 border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <button class="absolute right-2 top-1/2 -translate-y-1/2 text-blue-500 hover:text-blue-700">
                                        <i class="fa-solid fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="comments-list mt-4 space-y-3"></div>
                        </div>
                    `;
                    
                    postsContainer.appendChild(postElement);

                    // Add event listeners using .querySelector and .addEventListener
                    postElement.querySelector('.delete-post-btn')?.addEventListener('click', () => deletePost(postId));
                    postElement.querySelector('.like-btn')?.addEventListener('click', () => toggleLike(postId));
                    postElement.querySelector('.dislike-btn')?.addEventListener('click', () => toggleDislike(postId));
                    postElement.querySelector('.share-btn')?.addEventListener('click', () => showView('share', postId));
                    
                    const commentBtn = postElement.querySelector('.comment-btn');
                    const commentsSection = postElement.querySelector(`#comments-section-${postId}`);
                    commentBtn.addEventListener('click', () => {
                        commentsSection.classList.toggle('hidden');
                        if (!commentsSection.classList.contains('hidden')) {
                            renderComments(postId, commentsSection);
                        }
                    });

                    // Add comment form listener
                    const commentInput = commentsSection.querySelector('input');
                    const commentSendBtn = commentsSection.querySelector('button');
                    commentSendBtn.addEventListener('click', () => addComment(postId, commentInput));
                    commentInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') addComment(postId, commentInput);
                    });

                    // Real-time updates for likes, dislikes, and comments counts
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'posts', postId, 'likes'), (likesSnap) => {
                        const likesCount = likesSnap.docs.length;
                        const isLiked = likesSnap.docs.some(d => d.id === userId);
                        const likesBtn = postElement.querySelector('.like-btn');
                        if (likesBtn) {
                             likesBtn.querySelector('.like-count').textContent = likesCount;
                             likesBtn.querySelector('i').className = isLiked ? 'fa-solid fa-heart' : 'fa-regular fa-heart';
                        }
                    });

                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'posts', postId, 'dislikes'), (dislikesSnap) => {
                        const dislikesCount = dislikesSnap.docs.length;
                        const isDisliked = dislikesSnap.docs.some(d => d.id === userId);
                        const dislikesBtn = postElement.querySelector('.dislike-btn');
                        if (dislikesBtn) {
                             dislikesBtn.querySelector('.dislike-count').textContent = dislikesCount;
                             dislikesBtn.querySelector('i').className = isDisliked ? 'fa-solid fa-thumbs-down' : 'fa-regular fa-thumbs-down';
                        }
                    });
                    
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'posts', postId, 'comments'), (commentsSnap) => {
                        const commentsCount = commentsSnap.docs.length;
                        commentBtn.querySelector('.comment-count').textContent = commentsCount;
                    });
                });
            });
        }
        
        async function addComment(postId, inputElement, parentId = null) {
            const content = inputElement.value.trim();
            if (!content) return;

            const commentsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'posts', postId, 'comments');
            await addDoc(commentsColRef, {
                content: content,
                username: userProfile.username,
                displayName: userProfile.displayName,
                photoURL: userProfile.photoURL,
                userId: userId,
                parentId: parentId,
                createdAt: serverTimestamp(),
            });
            inputElement.value = '';
        }

        async function deleteComment(postId, commentId) {
            const confirmed = await showModal("Delete Comment", "Are you sure you want to delete this comment?", true);
            if (!confirmed) return;
            const commentDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'posts', postId, 'comments', commentId);
            await deleteDoc(commentDocRef);
            await showModal("Success", "Comment deleted.");
        }

        async function renderComments(postId, commentsSection) {
            const commentsList = commentsSection.querySelector('.comments-list');
            const commentsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'posts', postId, 'comments');

            onSnapshot(commentsColRef, (snapshot) => {
                commentsList.innerHTML = '';
                const allComments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Group comments by parentId for threading
                const commentsMap = {};
                allComments.forEach(c => {
                    commentsMap[c.id] = c;
                    c.replies = [];
                });
                
                const rootComments = [];
                allComments.forEach(c => {
                    if (c.parentId && commentsMap[c.parentId]) {
                        commentsMap[c.parentId].replies.push(c);
                    } else {
                        rootComments.push(c);
                    }
                });

                const sortedComments = rootComments.sort((a, b) => a.createdAt?.toMillis() - b.createdAt?.toMillis());
                
                function renderCommentAndReplies(comment, isReply = false) {
                    const commentElement = document.createElement('div');
                    const timeString = comment.createdAt ? new Date(comment.createdAt.toMillis()).toLocaleString() : 'Just now';
                    commentElement.className = `p-3 rounded-xl bg-gray-100 relative ${isReply ? 'ml-8 mt-2' : ''}`;
                    
                    commentElement.innerHTML = `
                        <div class="flex items-center space-x-2 mb-1">
                            <img src="${comment.photoURL || 'https://placehold.co/40x40/A0AEC0/ffffff?text=U'}" alt="Profile" class="w-8 h-8 rounded-full">
                            <div>
                                <p class="text-sm font-semibold text-gray-800">${comment.displayName}</p>
                                <p class="text-xs text-gray-500">@${comment.username} â€¢ ${timeString}</p>
                            </div>
                            <div class="ml-auto">
                                ${comment.userId === userId ? `
                                    <button class="delete-comment-btn text-gray-400 hover:text-red-500 transition-colors">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        <p class="text-gray-700 text-sm mb-2">${comment.content}</p>
                        <button class="text-xs text-blue-500 hover:underline reply-btn">Reply</button>
                    `;
                    
                    if (comment.userId === userId) {
                         commentElement.querySelector('.delete-comment-btn')?.addEventListener('click', () => deleteComment(postId, comment.id));
                    }
                    
                    const replyBtn = commentElement.querySelector('.reply-btn');
                    replyBtn.addEventListener('click', () => {
                        let replyForm = commentsList.querySelector(`#reply-form-${comment.id}`);
                        if (replyForm) {
                            replyForm.remove();
                        } else {
                            replyForm = document.createElement('div');
                            replyForm.id = `reply-form-${comment.id}`;
                            replyForm.className = `flex items-start space-x-2 mt-2 ml-8`;
                            replyForm.innerHTML = `
                                <img src="${userProfile?.photoURL || 'https://placehold.co/40x40/A0AEC0/ffffff?text=U'}" alt="Profile" class="w-8 h-8 rounded-full">
                                <div class="flex-1 relative">
                                    <input type="text" placeholder="Reply to @${comment.username}..." class="w-full p-2 text-sm rounded-lg border-2 border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <button class="absolute right-2 top-1/2 -translate-y-1/2 text-blue-500 hover:text-blue-700">
                                        <i class="fa-solid fa-paper-plane"></i>
                                    </button>
                                </div>
                            `;
                            commentElement.appendChild(replyForm);
                            
                            const replyInput = replyForm.querySelector('input');
                            const replySendBtn = replyForm.querySelector('button');
                            replySendBtn.addEventListener('click', () => addComment(postId, replyInput, comment.id));
                            replyInput.addEventListener('keypress', (e) => {
                                if (e.key === 'Enter') addComment(postId, replyInput, comment.id);
                            });
                        }
                    });
                    
                    commentsList.appendChild(commentElement);
                    
                    const sortedReplies = comment.replies.sort((a, b) => a.createdAt?.toMillis() - b.createdAt?.toMillis());
                    sortedReplies.forEach(reply => {
                        renderCommentAndReplies(reply, true);
                    });
                }
                
                sortedComments.forEach(comment => {
                    renderCommentAndReplies(comment);
                });
            });
        }
        
        async function toggleLike(postId) {
            const likeDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'posts', postId, 'likes', userId);
            const dislikeDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'posts', postId, 'dislikes', userId);
            const likeSnap = await getDoc(likeDocRef);

            if (likeSnap.exists()) {
                await deleteDoc(likeDocRef);
            } else {
                await setDoc(likeDocRef, { timestamp: serverTimestamp() });
                const dislikeSnap = await getDoc(dislikeDocRef);
                if (dislikeSnap.exists()) {
                    await deleteDoc(dislikeDocRef);
                }
            }
        }
        
        async function toggleDislike(postId) {
            const dislikeDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'posts', postId, 'dislikes', userId);
            const likeDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'posts', postId, 'likes', userId);
            const dislikeSnap = await getDoc(dislikeDocRef);

            if (dislikeSnap.exists()) {
                await deleteDoc(dislikeDocRef);
            } else {
                await setDoc(dislikeDocRef, { timestamp: serverTimestamp() });
                const likeSnap = await getDoc(likeDocRef);
                if (likeSnap.exists()) {
                    await deleteDoc(likeDocRef);
                }
            }
        }

        async function deletePost(postId) {
            const confirmed = await showModal("Delete Post", "Are you sure you want to delete this post?", true);
            if (confirmed) {
                const postDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'posts', postId);
                await deleteDoc(postDocRef);
                await showModal("Success", "Post deleted.");
            }
        }
        
        async function postTweet() {
            const content = document.getElementById('new-post-content').value.trim();
            if (!content) {
                await showModal("Error", "Post content cannot be empty.");
                return;
            }

            const postsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
            await addDoc(postsColRef, {
                content: content,
                displayName: userProfile.displayName,
                username: userProfile.username,
                photoURL: userProfile.photoURL,
                userId: userId,
                createdAt: serverTimestamp()
            });
            document.getElementById('new-post-content').value = '';
        }
        
        function renderUserProfilePage(username) {
            mainContent.innerHTML = `<div class="p-6 text-center text-gray-500">Loading profile...</div>`;
            
            const usernameRef = doc(db, 'artifacts', appId, 'public', 'data', 'usernames', username);
            getDoc(usernameRef).then(async (usernameSnap) => {
                if (!usernameSnap.exists()) {
                    mainContent.innerHTML = `<div class="p-6 text-center text-red-500">User @${username} not found.</div>`;
                    return;
                }
                
                const profileUserId = usernameSnap.data().userId;
                const profileDataRef = doc(db, 'artifacts', appId, 'users', profileUserId, 'profile', 'data');
                const profileSnap = await getDoc(profileDataRef);

                if (profileSnap.exists()) {
                    const profile = profileSnap.data();
                    if (profile.isBanned) {
                        mainContent.innerHTML = `
                            <div class="bg-white p-6 rounded-xl shadow-md mb-6 text-center">
                                <i class="fa-solid fa-ban text-6xl text-red-500 mb-4"></i>
                                <h2 class="text-xl font-bold text-gray-800">Account Banned</h2>
                                <p class="text-gray-600 mb-2">@${profile.username}</p>
                                <p class="text-gray-400">This account is no longer active.</p>
                            </div>
                        `;
                        return;
                    }

                    const profileHTML = `
                        <div class="bg-white p-6 rounded-xl shadow-md mb-6 text-center">
                            <img src="${profile?.photoURL || 'https://placehold.co/100x100/A0AEC0/ffffff?text=U'}" alt="My Profile" class="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-blue-500">
                            <h2 class="text-xl font-bold text-gray-800">${profile?.displayName}</h2>
                            <p class="text-gray-600 mb-2">@${profile?.username}</p>
                            <p class="text-gray-600 mb-2">${profile?.bio}</p>
                            <div class="flex justify-center space-x-2 mt-4">
                                ${profileUserId === userId ? `
                                    <button id="edit-profile-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-full text-sm font-semibold hover:bg-gray-300 transition-colors">Edit Profile</button>
                                ` : `
                                    <button id="message-user-btn" class="bg-blue-500 text-white px-4 py-2 rounded-full text-sm font-semibold hover:bg-blue-600 transition-colors">Message User</button>
                                `}
                                <button id="share-profile-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-full text-sm font-semibold hover:bg-gray-300 transition-colors">Share Profile</button>
                            </div>
                        </div>
                    `;
                    mainContent.innerHTML = profileHTML;
                    
                    if (profileUserId !== userId) {
                         document.getElementById('message-user-btn')?.addEventListener('click', () => {
                             startNewMessageByUsername(profile.username);
                         });
                    } else {
                         document.getElementById('edit-profile-btn')?.addEventListener('click', () => {
                            showView('editprofile');
                         });
                    }
                    
                    document.getElementById('share-profile-btn')?.addEventListener('click', () => {
                        const profileLink = `${window.location.origin}/profiles/@${profile.username}`;
                        navigator.clipboard.writeText(profileLink).then(() => {
                            showModal("Copied!", "Profile link copied to clipboard.");
                        }).catch(err => {
                            console.error('Could not copy text: ', err);
                            showModal("Error", "Could not copy link to clipboard.");
                        });
                    });
                } else {
                    mainContent.innerHTML = `<div class="p-6 text-center text-red-500">Profile data not found for this user.</div>`;
                }
            }).catch(error => {
                console.error("Error fetching user profile:", error);
                mainContent.innerHTML = `<div class="p-6 text-center text-red-500">Error loading profile.</div>`;
            });
        }

        // Render the profiles page
        function renderProfiles() {
            mainContent.innerHTML = `
                <!-- Current User Profile -->
                <div class="bg-white p-6 rounded-xl shadow-md mb-6 text-center">
                    <img src="${userProfile?.photoURL || 'https://placehold.co/100x100/A0AEC0/ffffff?text=U'}" alt="My Profile" class="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-blue-500">
                    <h2 class="text-xl font-bold text-gray-800">${userProfile?.displayName}</h2>
                    <p class="text-gray-600 mb-2">@${userProfile?.username}</p>
                    <p class="text-gray-600 mb-2">${userProfile?.bio}</p>
                    <div class="flex justify-center space-x-2 mt-4">
                        <button id="edit-my-profile-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-full text-sm font-semibold hover:bg-gray-300 transition-colors">Edit Profile</button>
                        <button id="share-my-profile-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-full text-sm font-semibold hover:bg-gray-300 transition-colors">Share Profile</button>
                    </div>
                </div>

                <!-- All Users List -->
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Other Users</h3>
                <div id="users-container" class="space-y-4">
                    <p class="text-center text-gray-500">Loading users...</p>
                </div>
            `;
            
            document.getElementById('edit-my-profile-btn').addEventListener('click', () => showView('editprofile'));
            document.getElementById('share-my-profile-btn').addEventListener('click', () => {
                const profileLink = `${window.location.origin}/profiles/@${userProfile.username}`;
                navigator.clipboard.writeText(profileLink).then(() => {
                    showModal("Copied!", "Profile link copied to clipboard.");
                }).catch(err => {
                    console.error('Could not copy text: ', err);
                    showModal("Error", "Could not copy link to clipboard.");
                });
            });

            const usersContainer = document.getElementById('users-container');
            const usersColRef = collection(db, 'artifacts', appId, 'users');
            
            onSnapshot(usersColRef, async (snapshot) => {
                usersContainer.innerHTML = '';
                for (const userDoc of snapshot.docs) {
                    const otherUserId = userDoc.id;
                    if (otherUserId !== userId) {
                        const profileRef = doc(userDoc.ref, 'profile', 'data');
                        const profileSnap = await getDoc(profileRef);

                        if (profileSnap.exists()) {
                            const profileData = profileSnap.data();
                            if (profileData.isBanned) continue; // Skip banned users

                            const userElement = document.createElement('div');
                            userElement.className = "flex items-center space-x-4 bg-white p-4 rounded-xl shadow-sm cursor-pointer hover:bg-gray-50 transition-colors";
                            userElement.innerHTML = `
                                <img src="${profileData?.photoURL || 'https://placehold.co/40x40/A0AEC0/ffffff?text=U'}" alt="Profile" class="w-12 h-12 rounded-full">
                                <div>
                                    <p class="font-semibold text-gray-800">${profileData?.displayName}</p>
                                    <p class="text-sm text-gray-500">${profileData?.bio}</p>
                                </div>
                                <button data-username="${profileData.username}" class="message-user-btn ml-auto bg-blue-500 text-white px-3 py-1 rounded-full text-sm hover:bg-blue-600 transition-colors">Message</button>
                            `;
                            userElement.querySelector('.message-user-btn').addEventListener('click', (e) => {
                                e.stopPropagation();
                                const username = e.currentTarget.getAttribute('data-username');
                                startNewMessageByUsername(username);
                            });
                            userElement.addEventListener('click', () => showView('user_profile', profileData.username));
                            usersContainer.appendChild(userElement);
                        }
                    }
                }
            });
        }

        // Render the messages page (list of sessions)
        function renderMessages() {
            mainContent.innerHTML = `
                <h2 class="text-lg font-bold text-gray-800 mb-4">Messages</h2>
                <div class="flex items-center space-x-2 mb-4">
                    <input type="text" id="start-new-message-username" class="flex-1 p-2 rounded-lg bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter a username to message...">
                    <button id="start-new-message-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600 transition-colors">Start</button>
                </div>
                <div id="sessions-container" class="space-y-4">
                    <p class="text-center text-gray-500">Loading messages...</p>
                </div>
            `;
            
            document.getElementById('start-new-message-btn').addEventListener('click', async () => {
                const username = document.getElementById('start-new-message-username').value.trim();
                if (username) {
                    await startNewMessageByUsername(username);
                } else {
                    await showModal("Error", "Please enter a username.");
                }
            });

            const sessionsColRef = collection(db, 'artifacts', appId, 'users', userId, 'dm_sessions');
            const sessionsContainer = document.getElementById('sessions-container');

            onSnapshot(sessionsColRef, async (snapshot) => {
                sessionsContainer.innerHTML = '';
                if (snapshot.empty) {
                    sessionsContainer.innerHTML = `<p class="text-center text-gray-500 mt-8">No message sessions yet.</p>`;
                }
                for (const doc of snapshot.docs) {
                    const session = doc.data();
                    const otherUserId = session.members.find(id => id !== userId);
                    if (!otherUserId) continue;

                    const otherUserProfileRef = doc(db, 'artifacts', appId, 'users', otherUserId, 'profile', 'data');
                    const otherUserProfileSnap = await getDoc(otherUserProfileRef);
                    const otherUserProfile = otherUserProfileSnap.exists() ? otherUserProfileSnap.data() : { displayName: 'Unknown User', photoURL: 'https://placehold.co/40x40/A0AEC0/ffffff?text=U' };

                    const sessionElement = document.createElement('div');
                    sessionElement.className = "flex items-center space-x-4 bg-white p-4 rounded-xl shadow-sm cursor-pointer hover:bg-gray-50 transition-colors";
                    sessionElement.innerHTML = `
                        <img src="${otherUserProfile.photoURL}" alt="User" class="w-12 h-12 rounded-full">
                        <div>
                            <p class="font-semibold text-gray-800">${otherUserProfile.displayName}</p>
                            <p class="text-sm text-gray-500 truncate w-48">${session.lastMessage || 'Start a conversation'}</p>
                        </div>
                    `;
                    sessionElement.addEventListener('click', () => showView('message_session', doc.id));
                    sessionsContainer.appendChild(sessionElement);
                }
            });
        }
        
        async function startNewMessageByUsername(username) {
            const sanitizedUsername = username.toLowerCase().replace('@', '').trim();
            if (!sanitizedUsername) {
                await showModal("Error", "Username cannot be empty.");
                return;
            }
            
            const usernameRef = doc(db, 'artifacts', appId, 'public', 'data', 'usernames', sanitizedUsername);
            const usernameSnap = await getDoc(usernameRef);
            
            if (!usernameSnap.exists()) {
                await showModal("Error", "Username not found. Please check spelling.");
                return;
            }
            
            const otherUserId = usernameSnap.data().userId;
            
            if (otherUserId === userId) {
                await showModal("Error", "You cannot message yourself.");
                return;
            }
            
            await startNewMessage(otherUserId);
        }
        
        async function startNewMessage(otherUserId) {
            const sessionPath = [userId, otherUserId].sort().join('_');
            const mySessionRef = doc(db, 'artifacts', appId, 'users', userId, 'dm_sessions', sessionPath);
            const mySnap = await getDoc(mySessionRef);
            
            if (!mySnap.exists()) {
                const userProfileRef = doc(db, 'artifacts', appId, 'users', userId, 'profile', 'data');
                const otherUserProfileRef = doc(db, 'artifacts', appId, 'users', otherUserId, 'profile', 'data');
                const [userSnap, otherUserSnap] = await Promise.all([getDoc(userProfileRef), getDoc(otherUserProfileRef)]);
                
                if (!otherUserSnap.exists()) {
                    await showModal("Error", "User not found. Please check the User ID.");
                    return;
                }
                const otherUserProfile = otherUserSnap.data();
                if (otherUserProfile.isBanned) {
                    await showModal("Error", "Cannot message a banned user.");
                    return;
                }

                const userDetails = { id: userId, displayName: userSnap.data().displayName, photoURL: userSnap.data().photoURL };
                const otherUserDetails = { id: otherUserId, displayName: otherUserProfile.displayName, photoURL: otherUserProfile.photoURL };
                
                const sessionData = {
                    members: [userId, otherUserId],
                    members_json: JSON.stringify([userDetails, otherUserDetails]),
                    createdAt: serverTimestamp(),
                    lastMessage: ''
                };
                
                const otherUserSessionRef = doc(db, 'artifacts', appId, 'users', otherUserId, 'dm_sessions', sessionPath);
                await Promise.all([
                    setDoc(mySessionRef, sessionData),
                    setDoc(otherUserSessionRef, sessionData)
                ]);
            }
            showView('message_session', sessionPath);
        }

        function renderMessageSession(dmSessionId) {
            mainContent.innerHTML = `
                <button id="back-to-messages-btn" class="text-blue-500 mb-4 hover:underline"><i class="fa-solid fa-arrow-left mr-2"></i>Back to messages</button>
                <div id="messages-list" class="flex flex-col space-y-4 mb-4 overflow-y-auto flex-1 h-full">
                    <p class="text-center text-gray-500">Loading messages...</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-md flex items-center space-x-2">
                    <input type="text" id="new-message-input" class="flex-1 p-2 rounded-lg bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type a message...">
                    <button id="send-message-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">Send</button>
                </div>
            `;
            
            document.getElementById('back-to-messages-btn').addEventListener('click', () => showView('messages'));
            document.getElementById('send-message-btn').addEventListener('click', sendMessage);
            document.getElementById('new-message-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            const messagesList = document.getElementById('messages-list');
            const messagesColRef = collection(db, 'artifacts', appId, 'users', userId, 'dm_sessions', dmSessionId, 'messages');
            const q = query(messagesColRef);

            onSnapshot(q, (snapshot) => {
                messagesList.innerHTML = '';
                const sortedMessages = snapshot.docs.sort((a, b) => a.data().createdAt?.toMillis() - b.data().createdAt?.toMillis());
                sortedMessages.forEach(doc => {
                    const message = doc.data();
                    const isMyMessage = message.from === userId;
                    const messageClass = isMyMessage ? 'self-end bg-blue-500 text-white rounded-bl-xl' : 'self-start bg-gray-200 text-gray-800 rounded-br-xl';
                    
                    const messageElement = document.createElement('div');
                    messageElement.className = `p-3 rounded-t-xl max-w-[80%] break-words ${messageClass}`;
                    messageElement.textContent = message.content;
                    messagesList.appendChild(messageElement);
                });
                messagesList.scrollTop = messagesList.scrollHeight;
            });
        }
        
        async function sendMessage() {
            const input = document.getElementById('new-message-input');
            const content = input.value.trim();
            if (!content) return;
            
            const urlPath = window.location.pathname.split('/');
            const dmSessionId = urlPath[2];
            const otherUserId = dmSessionId.replace(userId, '').replace('_', '');

            const myMessagesRef = collection(db, 'artifacts', appId, 'users', userId, 'dm_sessions', dmSessionId, 'messages');
            const otherUserMessagesRef = collection(db, 'artifacts', appId, 'users', otherUserId, 'dm_sessions', dmSessionId, 'messages');

            const messageData = {
                content: content,
                from: userId,
                to: otherUserId,
                createdAt: serverTimestamp()
            };

            await Promise.all([
                addDoc(myMessagesRef, messageData),
                addDoc(otherUserMessagesRef, messageData)
            ]);
            
            const mySessionDoc = doc(db, 'artifacts', appId, 'users', userId, 'dm_sessions', dmSessionId);
            const otherSessionDoc = doc(db, 'artifacts', appId, 'users', otherUserId, 'dm_sessions', dmSessionId);
            await Promise.all([
                updateDoc(mySessionDoc, { lastMessage: content }),
                updateDoc(otherSessionDoc, { lastMessage: content })
            ]);

            input.value = '';
        }

        async function renderSharePage(postId) {
            mainContent.innerHTML = `
                <div class="p-6 bg-white rounded-xl shadow-xl text-center">
                    <h2 class="text-2xl font-bold mb-4">Share This Post</h2>
                    <p class="text-gray-600 mb-4">Copy the link below to share this post with others.</p>
                    <div class="flex items-center space-x-2 bg-gray-100 rounded-lg p-2 mb-4">
                        <input type="text" id="share-link-input" class="flex-1 bg-transparent border-none focus:outline-none" value="${window.location.origin}/share/${postId}" readonly>
                        <button id="copy-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">Copy</button>
                    </div>
                    <div id="post-to-share" class="bg-gray-50 p-4 rounded-xl shadow-sm">
                        <p class="text-gray-500">Loading post...</p>
                    </div>
                    <button onclick="window.history.back()" class="mt-4 text-blue-500 hover:underline">Go back</button>
                </div>
            `;
            
            document.getElementById('copy-btn').addEventListener('click', () => {
                const linkInput = document.getElementById('share-link-input');
                linkInput.select();
                document.execCommand('copy');
                showModal("Copied!", "Link copied to clipboard.");
            });
            
            const postToShareContainer = document.getElementById('post-to-share');
            
            // Check for a valid postId first
            if (!postId) {
                postToShareContainer.innerHTML = `<p class="text-red-500">Invalid post link. Please go back and try again.</p>`;
                return;
            }

            // Now, fetch both the post and the author's profile
            try {
                const postDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'posts', postId);
                const postSnap = await getDoc(postDocRef);

                if (!postSnap.exists()) {
                    postToShareContainer.innerHTML = `<p class="text-red-500">Post not found.</p>`;
                    return;
                }

                const post = postSnap.data();
                const authorProfileRef = doc(db, 'artifacts', appId, 'users', post.userId, 'profile', 'data');
                const authorProfileSnap = await getDoc(authorProfileRef);

                const authorProfile = authorProfileSnap.exists() ? authorProfileSnap.data() : { isBanned: false };

                if (authorProfile.isBanned) {
                    postToShareContainer.innerHTML = `<p class="text-red-500">This post is from a banned user and cannot be shared.</p>`;
                    return;
                }

                const timeString = post.createdAt ? new Date(post.createdAt.toMillis()).toLocaleString() : 'Just now';

                postToShareContainer.innerHTML = `
                    <div class="flex items-center space-x-3 mb-2">
                        <img src="${post.photoURL || 'https://placehold.co/40x40/A0AEC0/ffffff?text=U'}" alt="Profile" class="w-10 h-10 rounded-full">
                        <div>
                            <p class="font-semibold text-gray-800">${post.displayName || post.name}</p>
                            <p class="text-xs text-gray-500">@${post.username || 'unknown'}</p>
                            <p class="text-xs text-gray-500">${timeString}</p>
                        </div>
                    </div>
                    <p class="text-gray-700 leading-relaxed">${post.content}</p>
                `;
            } catch (error) {
                console.error("Error fetching post data:", error);
                postToShareContainer.innerHTML = `<p class="text-red-500">An error occurred while loading the post.</p>`;
            }
        }

        // --- Event Listeners ---
        window.onload = () => {
            initFirebase();
            window.addEventListener('popstate', handleUrlChange);

            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const view = button.id.replace('nav-', '');
                    showView(view);
                });
            });
        };
    </script>
</body>
</html>
